<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂïÜÂìÅËØ¶ÊÉÖ - ËøêËê•ÊéßÂà∂Âè∞</title>
    <meta name="format-detection" content="telephone=no">
    <style>
        :root {
            --primary: #4ECDC4;
            --primary-light: #e8f8f7;
            --primary-dark: #3dbdb4;
            --danger: #ff6b6b;
            --warning: #ffa502;
            --success: #2ed573;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-tertiary: #9ca3af;
            --text-muted: #b2bec3;
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --bg-sidebar: #0b132b;
            --border: #e9ecef;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            min-height: 100vh;
            font-size: 14px;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            color: #dbeafe;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            padding: 28px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
        }

        .brand-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .brand-title {
            font-size: 18px;
            font-weight: 700;
            color: #f8fafc;
            letter-spacing: -0.3px;
        }

        .brand-version {
            font-size: 12px;
            color: rgba(219, 234, 254, 0.55);
            padding-left: 52px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 8px 12px;
            min-height: 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 8px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(186, 230, 253, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 14px;
            margin-bottom: 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 11px 14px;
            margin-bottom: 2px;
            color: rgba(219, 234, 254, 0.88);
            transition: all 0.15s;
            font-size: 14px;
            border-radius: var(--radius);
            font-weight: 500;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(46, 196, 182, 0.14);
            color: #ffffff;
        }

        .nav-item.active {
            background: linear-gradient(130deg, rgba(46, 196, 182, 0.38), rgba(56, 189, 248, 0.38));
            color: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .main {
            flex: 1;
            margin-left: 240px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            flex-direction: column;
        }

        .header-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-weight: 500;
        }

        .btn-default {
            background: #fff;
            border-color: var(--border);
            color: var(--text-secondary);
        }

        .btn-default:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .content {
            flex: 1;
            padding: 28px 32px;
            overflow-y: auto;
        }

        .product-detail-tabs {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #fff;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .product-detail-tab-btn {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            height: 38px;
            padding: 0 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .product-detail-tab-btn:hover {
            color: var(--text-primary);
            background: #f5f7fa;
        }

        .product-detail-tab-btn.active {
            color: #fff;
            background: linear-gradient(130deg, var(--primary), #38bdf8);
            box-shadow: 0 6px 14px rgba(46, 196, 182, 0.28);
        }

        .product-detail-tab-panel {
            display: none;
        }

        .product-detail-tab-panel.active {
            display: block;
        }

        .form-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-label .required {
            color: var(--danger);
            margin-left: 2px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            color: var(--text-primary);
            background: #fff;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .lang-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .lang-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .lang-section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .lang-section-badge {
            padding: 4px 10px;
            background: var(--primary);
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .option-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            box-shadow: var(--shadow-sm);
        }

        .option-card.active-spec {
            border-color: #bde9e6;
            box-shadow: 0 8px 22px rgba(46, 196, 182, 0.16);
        }

        .option-title {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .option-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .option-toolbar-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .option-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .option-item {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            background: #f5f5f5;
            color: var(--text-secondary);
        }

        .option-item:hover {
            background: var(--primary-light);
        }

        .option-item.selected {
            background: var(--primary);
            color: #fff;
            font-weight: 500;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-online {
            background: #e8f5e9;
            color: var(--success);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
        }

        .switch-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .switch-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .toast {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: #333;
            color: white;
            padding: 14px 32px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .tag-drawer-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 1200;
            align-items: stretch;
            justify-content: flex-end;
        }

        .tag-drawer-overlay.active {
            display: flex;
        }

        .tag-drawer {
            background: #fff;
            width: min(980px, 92vw);
            box-shadow: var(--shadow);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: row;
        }

        .tag-drawer-side {
            width: 260px;
            border-right: 1px solid var(--border);
            background: #fafcfd;
            display: flex;
            flex-direction: column;
        }

        .tag-drawer-side-header {
            padding: 18px 16px 10px;
            border-bottom: 1px solid var(--border);
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tag-tree {
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tag-tree-item {
            text-align: left;
            border: 1px solid transparent;
            background: transparent;
            border-radius: 10px;
            padding: 10px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tag-tree-item:hover {
            background: #f2f7f8;
            color: var(--text-primary);
        }

        .tag-tree-item.active {
            background: var(--primary-light);
            border-color: #bde9e6;
            color: var(--primary-dark);
            font-weight: 600;
        }

        .tag-drawer-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .tag-drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .tag-drawer-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tag-drawer-body {
            padding: 14px 20px 18px;
            overflow-y: auto;
            flex: 1;
        }

        .existing-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px dashed var(--border);
        }

        .existing-tag-item {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text-secondary);
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 240px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .existing-tag-item:hover {
            border-color: var(--primary);
            color: var(--primary-dark);
            background: var(--primary-light);
        }

        .existing-tag-item.active {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
            font-weight: 600;
        }

        .existing-tag-helper {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .tag-drawer-footer {
            padding: 14px 20px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid var(--border);
        }

        .modal-close {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text-secondary);
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
            border-color: #d4dbe3;
            background: #f8fafc;
        }

        .recipe-editor-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.42);
            z-index: 1250;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .recipe-editor-overlay.active {
            display: flex;
        }

        .recipe-editor-modal {
            width: min(920px, 100%);
            max-height: min(880px, calc(100vh - 40px));
            background: #fff;
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .recipe-editor-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            padding: 16px 20px 14px;
            border-bottom: 1px solid var(--border);
        }

        .recipe-editor-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .recipe-editor-subtitle {
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .recipe-editor-body {
            padding: 14px 20px 18px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recipe-group-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recipe-group-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .recipe-group-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .recipe-group-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .recipe-control-btn {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 12px;
            line-height: 1;
            height: 28px;
            padding: 0 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recipe-control-btn:hover {
            border-color: var(--primary);
            color: var(--primary-dark);
            background: var(--primary-light);
        }

        .recipe-control-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
            background: #f8fafc;
            border-color: var(--border);
            color: var(--text-muted);
        }

        .recipe-group-percent {
            min-width: 54px;
            text-align: center;
            border-radius: 999px;
            background: #f1f5f9;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 700;
            padding: 6px 8px;
        }

        .recipe-group-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .recipe-group-field-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .recipe-group-value {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.45;
            white-space: pre-line;
            word-break: break-word;
            background: #fff;
        }

        .recipe-group-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .recipe-editor-footer {
            padding: 14px 20px 18px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #fff;
        }

        .recipe-impact-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.42);
            z-index: 1260;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .recipe-impact-overlay.active {
            display: flex;
        }

        .recipe-impact-modal {
            width: min(820px, 100%);
            max-height: min(860px, calc(100vh - 40px));
            background: #fff;
            border-radius: 14px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .recipe-impact-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
            padding: 16px 20px 14px;
            border-bottom: 1px solid var(--border);
        }

        .recipe-impact-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .recipe-impact-subtitle {
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .recipe-impact-toolbar {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            background: #f8fafc;
        }

        .recipe-impact-toolbar .left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .recipe-impact-toolbar .right {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
        }

        .recipe-impact-body {
            padding: 10px 20px 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 120px;
        }

        .recipe-impact-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            background: #fff;
        }

        .recipe-impact-item input[type="checkbox"] {
            margin-top: 2px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .recipe-impact-item-body {
            flex: 1;
            min-width: 0;
        }

        .recipe-impact-item-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.4;
            word-break: break-word;
        }

        .recipe-impact-item-meta {
            margin-top: 2px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .recipe-impact-item-tag {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            background: #eef2ff;
            color: #3730a3;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            margin-left: 6px;
        }

        .recipe-impact-empty {
            padding: 20px 0;
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
        }

        .recipe-impact-footer {
            padding: 14px 20px 18px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #fff;
        }

        .tag-default-wrap {
            margin-top: 14px;
        }

        .tag-default-check {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .tag-default-check input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .tag-default-box {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid #cdd5df;
            background: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .tag-default-box::after {
            content: '';
            width: 10px;
            height: 6px;
            border-left: 2px solid #fff;
            border-bottom: 2px solid #fff;
            transform: rotate(-45deg) scale(0.7);
            opacity: 0;
            transition: all 0.2s;
            margin-top: -1px;
        }

        .tag-default-check input:checked + .tag-default-box {
            border-color: var(--primary);
            background: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .tag-default-check input:checked + .tag-default-box::after {
            opacity: 1;
            transform: rotate(-45deg) scale(1);
        }

        .tag-default-text {
            line-height: 1.2;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main {
                margin-left: 0;
            }

            .mobile-header {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                background: #fff;
                border-bottom: 1px solid var(--border);
                gap: 12px;
            }

            .back-btn {
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                background: none;
                border: none;
                cursor: pointer;
            }

            .header {
                padding: 16px;
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .content {
                padding: 16px;
            }

            .product-detail-tabs {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .product-detail-tab-btn {
                width: 100%;
            }

            .form-card {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }

            .lang-section {
                padding: 16px;
            }

            .recipe-editor-overlay {
                align-items: flex-end;
                padding: 0;
            }

            .recipe-editor-modal {
                width: 100%;
                max-height: 88vh;
                border-radius: 16px 16px 0 0;
            }

            .recipe-editor-header,
            .recipe-editor-body,
            .recipe-editor-footer {
                padding-left: 14px;
                padding-right: 14px;
            }

            .recipe-impact-overlay {
                align-items: flex-end;
                padding: 0;
            }

            .recipe-impact-modal {
                width: 100%;
                max-height: 88vh;
                border-radius: 16px 16px 0 0;
            }

            .recipe-impact-header,
            .recipe-impact-toolbar,
            .recipe-impact-body,
            .recipe-impact-footer {
                padding-left: 14px;
                padding-right: 14px;
            }

            .recipe-group-top {
                flex-direction: column;
                align-items: flex-start;
            }

            .recipe-group-controls {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (min-width: 769px) {
            .mobile-header {
                display: none;
            }
        }
        /* Ë∑®È°µÁªü‰∏Ä‰ºòÂåñÔºàÊ°åÈù¢ + ÁßªÂä®Ôºâ */
        .content {
            width: 100%;
            max-width: 1480px;
            margin: 0 auto;
        }

        .header {
            padding: 18px 28px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 14px 14px 12px;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .header-title {
                font-size: 30px;
                line-height: 1;
            }

            .header-right {
                flex-direction: row;
                gap: 8px;
                flex-wrap: wrap;
            }

            .content {
                padding: 14px;
            }

            .detail-card,
            .config-card,
            .summary-card {
                border-radius: 14px;
                box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
            }
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- ‰æßËæπÊ†è -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <div class="brand-icon"><img src="logo.png" alt="COFE+"></div>
                    <div class="brand-title">ËøêËê•ÊéßÂà∂Âè∞</div>
                </div>
                <div class="brand-version">Prototype v0</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ËøêËê•ÁÆ°ÁêÜ</div>
                    <a href="overview.html" class="nav-item">
                        <span class="nav-icon">üìä</span>
                        <span>ÊÄªËßà</span>
                    </a>
                    <a href="devices.html" class="nav-item">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>ËÆæÂ§á</span>
                    </a>
                    <a href="menu-management.html" class="nav-item active">
                        <span class="nav-icon">üìã</span>
                        <span>ÂïÜÂìÅÁÆ°ÁêÜ</span>
                    </a>
                    <a href="materials.html" class="nav-item">
                        <span class="nav-icon">üì¶</span>
                        <span>Áâ©Êñô</span>
                    </a>
                    <a href="orders.html" class="nav-item">
                        <span class="nav-icon">üìù</span>
                        <span>ËÆ¢Âçï</span>
                    </a>
                    <a href="faults.html" class="nav-item">
                        <span class="nav-icon">üõ†Ô∏è</span>
                        <span>ÊïÖÈöúÂàóË°®</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Âü∫Á°Ä‰ø°ÊÅØÁÆ°ÁêÜ</div>
                    <a href="customers.html" class="nav-item">
                        <span class="nav-icon">üè¢</span>
                        <span>ÂÆ¢Êà∑ÁÆ°ÁêÜ</span>
                    </a>
                    <a href="locations.html" class="nav-item">
                        <span class="nav-icon">üìç</span>
                        <span>ÁÇπ‰ΩçÁÆ°ÁêÜ</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- ‰∏ªÂÜÖÂÆπ -->
        <main class="main">
            <!-- ÁßªÂä®Á´ØÂ§¥ÈÉ® -->
            <div class="mobile-header">
                <button class="back-btn" onclick="goBack()">‚Üê</button>
                <span style="font-weight: 700; font-size: 17px;">ÂïÜÂìÅËØ¶ÊÉÖ</span>
            </div>

            <!-- È°∂ÈÉ®Ê†è -->
            <header class="header">
                <div class="header-left">
                    <span class="header-subtitle">Item detail</span>
                    <span class="header-title" id="productId">--</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-default" onclick="goBack()">ÂèñÊ∂à</button>
                    <button class="btn btn-primary" onclick="saveProduct()">‰øùÂ≠ò</button>
                </div>
            </header>

            <!-- ÂÜÖÂÆπÂå∫ -->
            <div class="content">
                <div class="product-detail-tabs" role="tablist" aria-label="ÂïÜÂìÅËØ¶ÊÉÖÂàÜÁªÑ">
                    <button type="button" class="product-detail-tab-btn active" id="productDetailTabBasicBtn" aria-selected="true" onclick="switchProductDetailTab('basic')">Âü∫Êú¨‰ø°ÊÅØ</button>
                    <button type="button" class="product-detail-tab-btn" id="productDetailTabRecipeBtn" aria-selected="false" onclick="switchProductDetailTab('recipe')">ÈÖçÊñπÈÖçÁΩÆ</button>
                </div>

                <section class="product-detail-tab-panel active" id="productDetailBasicPanel">
                    <div class="form-card">
                        <h2 class="form-section-title">Âü∫Êú¨‰ø°ÊÅØ</h2>

                        <!-- ÂïÜÂìÅÂõæÁâá -->
                        <div class="form-group">
                            <label class="form-label">ÂïÜÂìÅÂõæÁâá</label>
                            <div id="productImagePreview" style="margin-bottom: 12px;">
                                <!-- Âä®ÊÄÅÊòæÁ§∫ÂõæÁâá -->
                            </div>
                            <input type="text" class="form-input" id="productImage" placeholder="ËØ∑ËæìÂÖ•ÂõæÁâáURL">
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºèÂõæÁâáÈìæÊé•ÔºåÊàñ‰∏ä‰º†Êú¨Âú∞ÂõæÁâá</div>
                            <input type="file" class="form-input" id="productImageFile" accept="image/*" style="margin-top: 8px; padding: 9px 12px;">
                        </div>
                        
                        <!-- Â§öËØ≠Ë®ÄÂêçÁß∞ÂíåÊèèËø∞ -->
                        <div id="multiLangInputs">
                            <!-- Âä®ÊÄÅÁîüÊàê -->
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÊâÄÂ±ûÂàÜÁ±ª</label>
                                <input type="text" class="form-input" id="categoryName" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂïÜÂìÅ‰ª∑Ê†º <span class="required">*</span></label>
                                <input type="number" class="form-input" id="productPrice" step="0.1" min="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Âéü‰ª∑ÔºàÂèØÈÄâÔºâ</label>
                                <input type="number" class="form-input" id="productOriginalPrice" step="0.1" min="0" placeholder="‰æãÂ¶Ç 12.9">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Â∏ÅÁßç</label>
                                <select class="form-select" id="productCurrency">
                                    <option value="CNY">CNY</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="HKD">HKD</option>
                                    <option value="JPY">JPY</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ÂïÜÂìÅÁä∂ÊÄÅ</label>
                                <div class="switch-group" style="margin-top: 8px;">
                                    <label class="switch">
                                        <input type="checkbox" id="onSaleSwitch" checked>
                                        <span class="slider"></span>
                                    </label>
                                    <span class="switch-label" id="onSaleLabel">Âú®ÂîÆ</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ÂäüËÉΩÂºÄÂÖ≥</label>
                                <div class="switch-group" style="margin-top: 8px;">
                                    <label class="switch">
                                        <input type="checkbox" id="featuredSwitch" checked>
                                        <span class="slider"></span>
                                    </label>
                                    <span class="switch-label">Êé®ËçêÂïÜÂìÅ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="product-detail-tab-panel" id="productDetailRecipePanel">
                    <div class="option-toolbar">
                        <div class="option-toolbar-title">ÈÖçÊñπÈÖçÁΩÆ</div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-default" id="openRecipeEditorBtn" onclick="openRecipeEditorForActiveSpec()">‰øÆÊîπÈÖçÊñπ</button>
                            <button class="btn btn-default" onclick="openTagConfigDrawer('beans')">Ê†áÁ≠æÈÖçÁΩÆ</button>
                        </div>
                    </div>

                    <div class="option-card active-spec" data-spec-key="beans">
                        <div class="option-title">BEAN / ÂíñÂï°Ë±Ü</div>
                        <div class="option-list" id="beanOptions">
                            <div class="option-item" data-value="Á≤æÂìÅÂíñÂï°-Áø°Áø†Áë∞Â§è">Á≤æÂìÅÂíñÂï°-Áø°Áø†Áë∞Â§è</div>
                            <div class="option-item selected" data-value="ÈáëÂ•ñÈªëÂíñ-ÊµìÈ¶ôÊÑèÂºè">ÈáëÂ•ñÈªëÂíñ-ÊµìÈ¶ôÊÑèÂºè</div>
                        </div>
                    </div>

                    <div class="option-card" data-spec-key="temperature">
                        <div class="option-title">TEMPERATURE / Ê∏©Â∫¶</div>
                        <div class="option-list" id="tempOptions">
                            <div class="option-item selected" data-value="ÁÉ≠">ÁÉ≠</div>
                            <div class="option-item" data-value="ÂÜ∞">ÂÜ∞</div>
                            <div class="option-item" data-value="Â∏∏Ê∏©">Â∏∏Ê∏©</div>
                        </div>
                    </div>

                    <div class="option-card" data-spec-key="strength">
                        <div class="option-title">PROFILE / ÊµìÂ∫¶</div>
                        <div class="option-list" id="profileOptions">
                            <div class="option-item selected" data-value="Ê†áÂáÜ">Ê†áÂáÜ</div>
                            <div class="option-item" data-value="Âä†1‰ªΩÊµìÁº©">Âä†1‰ªΩÊµìÁº©</div>
                            <div class="option-item" data-value="Âä†2‰ªΩÊµìÁº©">Âä†2‰ªΩÊµìÁº©</div>
                        </div>
                    </div>

                    <div class="option-card" data-spec-key="syrup">
                        <div class="option-title">SYRUP / Á≥ñÊµÜ</div>
                        <div class="option-list" id="syrupOptions">
                            <div class="option-item selected" data-value="ÁîòËîóÂÜ∞Á≥ñÁ≥ñÊµÜ">ÁîòËîóÂÜ∞Á≥ñÁ≥ñÊµÜ</div>
                            <div class="option-item" data-value="È¶ôËçâÈ£éÂë≥Á≥ñÊµÜ">È¶ôËçâÈ£éÂë≥Á≥ñÊµÜ</div>
                            <div class="option-item" data-value="Ê¶õÊûúÈ£éÂë≥Á≥ñÊµÜ">Ê¶õÊûúÈ£éÂë≥Á≥ñÊµÜ</div>
                            <div class="option-item" data-value="Êó†Á≥ñÊµÜ">Êó†Á≥ñÊµÜ</div>
                        </div>
                    </div>

                    <div class="option-card" data-spec-key="sweetness">
                        <div class="option-title">SWEETNESS / ÁîúÂ∫¶</div>
                        <div class="option-list" id="sweetnessOptions">
                            <div class="option-item selected" data-value="Êó†Á≥ñ">Êó†Á≥ñ</div>
                            <div class="option-item" data-value="Â∞ëÁ≥ñ">Â∞ëÁ≥ñ</div>
                            <div class="option-item" data-value="Ê†áÂáÜÁ≥ñ">Ê†áÂáÜÁ≥ñ</div>
                            <div class="option-item" data-value="Â§öÁ≥ñ">Â§öÁ≥ñ</div>
                        </div>
                    </div>

                    <div class="option-card" data-spec-key="cupsize">
                        <div class="option-title">CUPSIZE / ÊùØÂûã</div>
                        <div class="option-list" id="cupsizeOptions">
                            <div class="option-item selected" data-value="355ml">355ml</div>
                            <div class="option-item" data-value="473ml">473ml</div>
                            <div class="option-item" data-value="592ml">592ml</div>
                        </div>
                    </div>

                    <div class="option-card" data-spec-key="lid">
                        <div class="option-title">LID / ÊùØÁõñ</div>
                        <div class="option-list" id="lidOptions">
                            <div class="option-item selected" data-value="ÂÄ°ÂØºÁéØ‰øù ‰∏ç‰ΩøÁî®ÊùØÁõñ">ÂÄ°ÂØºÁéØ‰øù ‰∏ç‰ΩøÁî®ÊùØÁõñ</div>
                            <div class="option-item" data-value="ÈúÄË¶ÅÊùØÁõñ">ÈúÄË¶ÅÊùØÁõñ</div>
                        </div>
                    </div>

                    <div class="option-card" data-spec-key="latteArt">
                        <div class="option-title">LATTE-ART / ÊãâËä±</div>
                        <div class="option-list" id="latteArtOptions">
                            <div class="option-item selected" data-value="Êó†">Êó†</div>
                            <div class="option-item" data-value="ÈöèÊú∫ÊãâËä±">ÈöèÊú∫ÊãâËä±</div>
                            <div class="option-item" data-value="‰∏ä‰º†ÂõæÁâá">‰∏ä‰º†ÂõæÁâá</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div class="tag-drawer-overlay" id="tagConfigDrawer">
        <div class="tag-drawer">
            <aside class="tag-drawer-side">
                <div class="tag-drawer-side-header">Ê†áÁ≠æÁ±ªÂûã</div>
                <div class="tag-tree" id="tagTree"></div>
            </aside>
            <section class="tag-drawer-main">
                <div class="tag-drawer-header">
                    <div class="tag-drawer-title" id="tagDrawerTitle">Ê†áÁ≠æÈÖçÁΩÆ</div>
                    <button class="modal-close" onclick="closeTagConfigDrawer()">√ó</button>
                </div>
                <div class="tag-drawer-body" id="tagDrawerEditor"></div>
                <div class="tag-drawer-footer">
                    <button class="btn btn-default" onclick="closeTagConfigDrawer()">ÂèñÊ∂à</button>
                    <button class="btn btn-primary" onclick="saveTagConfigDrawer()">‰øùÂ≠ò</button>
                </div>
            </section>
        </div>
    </div>

    <div class="recipe-editor-overlay" id="recipeEditorModal">
        <div class="recipe-editor-modal">
            <div class="recipe-editor-header">
                <div>
                    <div class="recipe-editor-title">ÈÖçÊñπË∞ÉÊï¥</div>
                    <div class="recipe-editor-subtitle" id="recipeEditorSubtitle">--</div>
                </div>
                <button class="modal-close" type="button" onclick="closeRecipeEditor()">√ó</button>
            </div>
            <div class="recipe-editor-body" id="recipeEditorBody"></div>
            <div class="recipe-editor-footer">
                <button class="btn btn-default" type="button" onclick="closeRecipeEditor()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" type="button" onclick="saveRecipeEditor()">‰øùÂ≠òÈÖçÊñπ</button>
            </div>
        </div>
    </div>

    <div class="recipe-impact-overlay" id="recipeImpactModal">
        <div class="recipe-impact-modal">
            <div class="recipe-impact-header">
                <div>
                    <div class="recipe-impact-title">ÂΩ±ÂìçÂïÜÂìÅÁ°ÆËÆ§</div>
                    <div class="recipe-impact-subtitle" id="recipeImpactSubtitle">ÂãæÈÄâÁöÑÂïÜÂìÅÂ∞Ü‰øùÊåÅÂéüÈÖçÊñπ‰∏çÂèò</div>
                </div>
                <button class="modal-close" type="button" onclick="closeRecipeImpactModal()">√ó</button>
            </div>
            <div class="recipe-impact-toolbar">
                <div class="left">
                    <button type="button" class="recipe-control-btn" onclick="selectAllRecipeImpactExclusions()">ÂÖ®ÈÄâÊéíÈô§</button>
                    <button type="button" class="recipe-control-btn" onclick="clearRecipeImpactExclusions()">Ê∏ÖÁ©∫ÊéíÈô§</button>
                </div>
                <div class="right" id="recipeImpactSummary">Â∞ÜÊõ¥Êñ∞ 0 ‰∏™ÔºåÊéíÈô§ 0 ‰∏™</div>
            </div>
            <div class="recipe-impact-body" id="recipeImpactBody"></div>
            <div class="recipe-impact-footer">
                <button class="btn btn-default" type="button" onclick="closeRecipeImpactModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" type="button" onclick="confirmRecipeImpactApply()">Á°ÆËÆ§‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ËÆæÂ§áÈÖçÁΩÆ
        const deviceConfig = {
            'RCK111': { langs: ['zh', 'en'], langNames: { 'zh': '‰∏≠Êñá', 'en': 'English' } },
            'RCK112': { langs: ['zh', 'en', 'jp'], langNames: { 'zh': '‰∏≠Êñá', 'en': 'English', 'jp': 'Êó•Êú¨Ë™û' } },
            'RCK113': { langs: ['zh', 'en', 'ko', 'th'], langNames: { 'zh': '‰∏≠Êñá', 'en': 'English', 'ko': 'ÌïúÍµ≠Ïñ¥', 'th': '‡πÑ‡∏ó‡∏¢' } }
        };

        let productData = null;
        let categoryNames = {};
        let linkedProductCatalog = [];
        let currentDevice = 'RCK111';
        let currentLang = 'zh';
        let currentProductDetailTab = 'basic';
        let activeRecipeSpecKey = 'beans';
        let recipeEditorState = null;
        let recipeImpactState = null;
        let drawerActiveSpecKey = 'beans';
        let drawerSelectedTagKey = '';
        const tagConfigs = [
            { specKey: 'beans', title: 'ÂíñÂï°Ë±Ü', listId: 'beanOptions', optionTitle: 'BEAN' },
            { specKey: 'temperature', title: 'Ê∏©Â∫¶', listId: 'tempOptions', optionTitle: 'TEMPERATURE' },
            { specKey: 'strength', title: 'ÊµìÂ∫¶', listId: 'profileOptions', optionTitle: 'PROFILE' },
            { specKey: 'syrup', title: 'Á≥ñÊµÜ', listId: 'syrupOptions', optionTitle: 'SYRUP' },
            { specKey: 'sweetness', title: 'ÁîúÂ∫¶', listId: 'sweetnessOptions', optionTitle: 'SWEETNESS' },
            { specKey: 'cupsize', title: 'ÊùØÂûã', listId: 'cupsizeOptions', optionTitle: 'CUPSIZE' },
            { specKey: 'lid', title: 'ÊùØÁõñ', listId: 'lidOptions', optionTitle: 'LID' },
            { specKey: 'latteArt', title: 'ÊãâËä±', listId: 'latteArtOptions', optionTitle: 'LATTE-ART' }
        ];
        const SUPPORTED_CURRENCIES = {
            CNY: { decimals: 2 },
            USD: { decimals: 2 },
            EUR: { decimals: 2 },
            HKD: { decimals: 2 },
            JPY: { decimals: 0 }
        };
        const RECIPE_GROUP_CONFIGS = [
            { key: 'baseCoffeeLiquid', title: 'Âü∫Â∫ïÂíñÂï°Ê∂≤', multi: false, defaultNames: ['Âü∫Â∫ïÂíñÂï°Ê∂≤'] },
            { key: 'syrup', title: 'Á≥ñÊµÜ', multi: false, defaultNames: ['Á≥ñÊµÜ'] },
            { key: 'milk', title: 'Â•∂Èáè', multi: false, defaultNames: ['ÁâõÂ•∂'] },
            { key: 'water', title: 'Ê∞¥Èáè', multi: false, defaultNames: ['Ê∞¥'] },
            { key: 'ice', title: 'ÂÜ∞Èáè', multi: false, defaultNames: ['ÂÜ∞'] },
            { key: 'powders', title: 'ÊµìÁº©Á≤âÂêçÁß∞', multi: true, defaultNames: [] },
            { key: 'concentrates', title: 'ÊµìÁº©Ê∂≤', multi: true, defaultNames: [] },
            { key: 'decorToppings', title: 'Ë£ÖÈ•∞È¢óÁ≤íÂêçÁß∞', multi: true, defaultNames: [] }
        ];
        const RECIPE_GROUP_KEYS = RECIPE_GROUP_CONFIGS.map(item => item.key);

        function normalizeCurrency(code) {
            const upper = String(code || 'CNY').toUpperCase();
            return SUPPORTED_CURRENCIES[upper] ? upper : 'CNY';
        }

        function updatePricePreview() {
            // È¢ÑÁïôÔºö‰ª∑Ê†ºÁõ∏ÂÖ≥ËÅîÂä®ÂÖ•Âè£
        }

        function getDeviceLangs() {
            return deviceConfig[currentDevice]?.langs || ['zh', 'en'];
        }

        function getLangName(lang) {
            return deviceConfig[currentDevice]?.langNames[lang] || lang;
        }

        function getSpec(lang) {
            return (productData?.specs && productData.specs[lang]) || {};
        }

        function setSpec(lang, patch) {
            if (!productData.specs) productData.specs = {};
            const curr = productData.specs[lang] || {};
            productData.specs[lang] = { ...curr, ...patch };
        }

        function getDefaultOption(specKey) {
            return (productData.defaultOptions && productData.defaultOptions[specKey]) || '';
        }

        function setDefaultOption(specKey, value) {
            if (!productData.defaultOptions) productData.defaultOptions = {};
            if (value) productData.defaultOptions[specKey] = value;
            else delete productData.defaultOptions[specKey];
        }

        function getTagConfigBySpec(specKey) {
            return tagConfigs.find(cfg => cfg.specKey === specKey);
        }

        function getTagKeys(specKey) {
            const cfg = getTagConfigBySpec(specKey);
            if (!cfg) return [];
            const list = document.getElementById(cfg.listId);
            if (!list) return [];
            return Array.from(list.querySelectorAll('.option-item')).map(item => {
                if (!item.dataset.tagKey) item.dataset.tagKey = item.dataset.value;
                return item.dataset.tagKey;
            });
        }

        function ensureTagI18n(specKey) {
            if (!productData.tagI18n) productData.tagI18n = {};
            if (!productData.tagI18n[specKey]) productData.tagI18n[specKey] = {};

            const keys = getTagKeys(specKey);
            keys.forEach(key => {
                if (!productData.tagI18n[specKey][key]) productData.tagI18n[specKey][key] = {};
                if (!productData.tagI18n[specKey][key].zh) productData.tagI18n[specKey][key].zh = key;
            });
        }

        function getTagLabel(specKey, tagKey, lang) {
            ensureTagI18n(specKey);
            const i18n = productData.tagI18n?.[specKey]?.[tagKey] || {};
            return i18n[lang] || i18n.zh || tagKey;
        }

        function refreshOptionListLabels(specKey) {
            const cfg = getTagConfigBySpec(specKey);
            if (!cfg) return;
            const list = document.getElementById(cfg.listId);
            if (!list) return;

            list.querySelectorAll('.option-item').forEach(item => {
                if (!item.dataset.tagKey) item.dataset.tagKey = item.dataset.value;
                const key = item.dataset.tagKey;
                item.dataset.value = key;
                item.textContent = getTagLabel(specKey, key, currentLang);
            });
        }

        function resolveTagKey(specKey, rawValue) {
            if (!rawValue) return '';
            const keys = getTagKeys(specKey);
            if (keys.includes(rawValue)) return rawValue;
            const matched = keys.find(key => getTagLabel(specKey, key, currentLang) === rawValue);
            return matched || '';
        }

        function getCurrentSelectedTagKey(specKey) {
            const cfg = getTagConfigBySpec(specKey);
            if (!cfg) return '';
            const selected = document.querySelector(`#${cfg.listId} .option-item.selected`);
            if (!selected) return '';
            if (!selected.dataset.tagKey) selected.dataset.tagKey = selected.dataset.value;
            return selected.dataset.tagKey;
        }

        function syncSelectedOption(listId, value) {
            if (!value) return;
            const list = document.getElementById(listId);
            if (!list) return;
            const target = Array.from(list.querySelectorAll('.option-item')).find(item => item.dataset.value === value);
            if (!target) return;
            list.querySelectorAll('.option-item').forEach(item => item.classList.remove('selected'));
            target.classList.add('selected');
        }

        function updateOnSaleLabel() {
            const onSale = document.getElementById('onSaleSwitch').checked;
            document.getElementById('onSaleLabel').textContent = onSale ? 'Âú®ÂîÆ' : '‰∏çÂú®ÂîÆ';
        }

        function switchProductDetailTab(tabKey) {
            const nextTab = tabKey === 'recipe' ? 'recipe' : 'basic';
            currentProductDetailTab = nextTab;

            const isBasic = nextTab === 'basic';
            const basicBtn = document.getElementById('productDetailTabBasicBtn');
            const recipeBtn = document.getElementById('productDetailTabRecipeBtn');
            const basicPanel = document.getElementById('productDetailBasicPanel');
            const recipePanel = document.getElementById('productDetailRecipePanel');

            if (basicBtn) {
                basicBtn.classList.toggle('active', isBasic);
                basicBtn.setAttribute('aria-selected', isBasic ? 'true' : 'false');
            }
            if (recipeBtn) {
                recipeBtn.classList.toggle('active', !isBasic);
                recipeBtn.setAttribute('aria-selected', isBasic ? 'false' : 'true');
            }
            if (basicPanel) {
                basicPanel.classList.toggle('active', isBasic);
            }
            if (recipePanel) {
                recipePanel.classList.toggle('active', !isBasic);
            }
        }

        function getRecipeGroupConfig(groupKey) {
            return RECIPE_GROUP_CONFIGS.find(item => item.key === groupKey) || null;
        }

        function normalizeRecipePercent(value) {
            const num = Number(value);
            if (!Number.isFinite(num)) return 100;
            const stepped = Math.round(num / 10) * 10;
            return Math.max(10, Math.min(300, stepped));
        }

        function formatRecipeGroupNames(names, isMulti) {
            const list = Array.isArray(names) ? names.filter(Boolean) : [];
            if (!list.length) return 'Êú™ÈÖçÁΩÆ';
            return isMulti ? list.join('„ÄÅ') : list[0];
        }

        function getDefaultRecipeData(optionLabel = '') {
            const groups = {};
            RECIPE_GROUP_CONFIGS.forEach(cfg => {
                const names = cfg.key === 'baseCoffeeLiquid' && optionLabel
                    ? [optionLabel]
                    : [...cfg.defaultNames];
                groups[cfg.key] = {
                    names,
                    percent: 100
                };
            });

            return {
                groupOrder: [...RECIPE_GROUP_KEYS],
                groups
            };
        }

        function normalizeRecipeData(rawRecipe, optionLabel = '') {
            const fallback = getDefaultRecipeData(optionLabel);
            const recipe = rawRecipe && typeof rawRecipe === 'object' ? rawRecipe : {};
            const incomingOrder = Array.isArray(recipe.groupOrder) ? recipe.groupOrder.filter(key => RECIPE_GROUP_KEYS.includes(key)) : [];
            const dedupedOrder = [];
            incomingOrder.forEach(key => {
                if (!dedupedOrder.includes(key)) dedupedOrder.push(key);
            });
            RECIPE_GROUP_KEYS.forEach(key => {
                if (!dedupedOrder.includes(key)) dedupedOrder.push(key);
            });

            const groups = {};
            RECIPE_GROUP_CONFIGS.forEach(cfg => {
                const sourceGroup = recipe.groups && typeof recipe.groups === 'object' ? recipe.groups[cfg.key] : null;
                const defaultGroup = fallback.groups[cfg.key];
                const namesRaw = Array.isArray(sourceGroup?.names) ? sourceGroup.names : defaultGroup.names;
                const names = namesRaw.map(item => String(item || '').trim()).filter(Boolean);
                groups[cfg.key] = {
                    names: cfg.multi ? names : (names.length ? [names[0]] : []),
                    percent: normalizeRecipePercent(sourceGroup?.percent ?? defaultGroup.percent)
                };
            });

            return {
                groupOrder: dedupedOrder,
                groups
            };
        }

        function getSelectedOptionInfo(specKey) {
            const cfg = getTagConfigBySpec(specKey);
            if (!cfg) return null;
            const selected = document.querySelector(`#${cfg.listId} .option-item.selected`);
            if (!selected) return null;

            if (!selected.dataset.tagKey) selected.dataset.tagKey = selected.dataset.value;
            const tagKey = selected.dataset.tagKey || selected.dataset.value;
            if (!tagKey) return null;

            return {
                specKey,
                tagKey,
                tagLabel: getTagLabel(specKey, tagKey, currentLang)
            };
        }

        function ensureOptionRecipeStore(targetProduct = productData) {
            if (!targetProduct || typeof targetProduct !== 'object') {
                return {};
            }
            if (!targetProduct.optionRecipes || typeof targetProduct.optionRecipes !== 'object') {
                targetProduct.optionRecipes = {};
            }
            return targetProduct.optionRecipes;
        }

        function ensureOptionRecipeLinkStore(targetProduct = productData) {
            if (!targetProduct || typeof targetProduct !== 'object') {
                return {};
            }
            if (!targetProduct.optionRecipeLinks || typeof targetProduct.optionRecipeLinks !== 'object') {
                targetProduct.optionRecipeLinks = {};
            }
            return targetProduct.optionRecipeLinks;
        }

        function getOptionRecipe(specKey, tagKey, optionLabel = '', targetProduct = productData) {
            const store = ensureOptionRecipeStore(targetProduct);
            const bySpec = store[specKey] && typeof store[specKey] === 'object' ? store[specKey] : {};
            return normalizeRecipeData(bySpec[tagKey], optionLabel);
        }

        function setOptionRecipe(specKey, tagKey, recipeData, optionLabel = '', targetProduct = productData) {
            const store = ensureOptionRecipeStore(targetProduct);
            if (!store[specKey] || typeof store[specKey] !== 'object') {
                store[specKey] = {};
            }
            store[specKey][tagKey] = normalizeRecipeData(recipeData, optionLabel);
        }

        function getOptionRecipeLinkId(specKey, tagKey, targetProduct = productData) {
            const links = ensureOptionRecipeLinkStore(targetProduct);
            const bySpec = links[specKey] && typeof links[specKey] === 'object' ? links[specKey] : {};
            return String(bySpec[tagKey] || `${specKey}:${tagKey}`);
        }

        function setOptionRecipeLinkId(specKey, tagKey, linkId, targetProduct = productData) {
            const links = ensureOptionRecipeLinkStore(targetProduct);
            if (!links[specKey] || typeof links[specKey] !== 'object') {
                links[specKey] = {};
            }
            links[specKey][tagKey] = String(linkId || `${specKey}:${tagKey}`);
        }

        function setActiveRecipeSpec(specKey) {
            if (!getTagConfigBySpec(specKey)) return;
            activeRecipeSpecKey = specKey;
            document.querySelectorAll('.option-card[data-spec-key]').forEach(card => {
                card.classList.toggle('active-spec', card.dataset.specKey === specKey);
            });
        }

        function openRecipeEditorForActiveSpec() {
            openRecipeEditor(activeRecipeSpecKey);
        }

        function getCatalogEntries() {
            if (Array.isArray(linkedProductCatalog) && linkedProductCatalog.length) {
                return linkedProductCatalog;
            }
            return [{
                id: productData?.id,
                category: categoryNames,
                product: productData
            }];
        }

        function getEntryProduct(entry) {
            if (!entry || typeof entry !== 'object') return null;
            if (entry.product && typeof entry.product === 'object') return entry.product;
            return entry;
        }

        function getEntryId(entry) {
            const product = getEntryProduct(entry);
            const id = Number(product?.id ?? entry?.id);
            return Number.isFinite(id) ? id : null;
        }

        function resolveProductDisplayName(product) {
            if (!product || typeof product !== 'object') return 'Êú™Áü•ÂïÜÂìÅ';
            return String(
                product.names?.[currentLang]
                || product.names?.zh
                || product.names?.en
                || product.name
                || `ÂïÜÂìÅ#${product.id || '--'}`
            );
        }

        function resolveEntryCategoryName(entry) {
            const categoryObj = entry?.category || entry?.categoryNames || {};
            return String(categoryObj[currentLang] || categoryObj.zh || categoryObj.en || entry?.categoryKey || '-');
        }

        function resolveProductTagLabel(product, specKey, tagKey) {
            const i18n = product?.tagI18n?.[specKey]?.[tagKey];
            if (i18n && typeof i18n === 'object') {
                return String(i18n[currentLang] || i18n.zh || i18n.en || tagKey);
            }
            return String(tagKey);
        }

        function getRecipeImpactEntries(specKey, tagKey, linkId) {
            const entries = getCatalogEntries();
            return entries
                .map(entry => {
                    const product = getEntryProduct(entry);
                    const id = getEntryId(entry);
                    if (!product || id === null) return null;
                    if (productData && Number(productData.id) === id) return null;
                    const productLinkId = getOptionRecipeLinkId(specKey, tagKey, product);
                    if (productLinkId !== linkId) return null;
                    return {
                        id,
                        product,
                        entry,
                        name: resolveProductDisplayName(product),
                        categoryName: resolveEntryCategoryName(entry),
                        tagLabel: resolveProductTagLabel(product, specKey, tagKey)
                    };
                })
                .filter(Boolean)
                .sort((a, b) => a.id - b.id);
        }

        function buildUniqueRecipeLinkId(specKey, tagKey, productId) {
            return `${specKey}:${tagKey}:keep:${productId}:${Date.now()}`;
        }

        function openRecipeImpactModal() {
            if (!recipeImpactState) return;
            renderRecipeImpactModal();
            const modal = document.getElementById('recipeImpactModal');
            if (modal) modal.classList.add('active');
        }

        function closeRecipeImpactModal() {
            const modal = document.getElementById('recipeImpactModal');
            if (modal) modal.classList.remove('active');
            recipeImpactState = null;
        }

        function selectAllRecipeImpactExclusions() {
            if (!recipeImpactState) return;
            recipeImpactState.excludedIds = new Set(recipeImpactState.affectedEntries.map(item => item.id));
            renderRecipeImpactModal();
        }

        function clearRecipeImpactExclusions() {
            if (!recipeImpactState) return;
            recipeImpactState.excludedIds = new Set();
            renderRecipeImpactModal();
        }

        function toggleRecipeImpactExclusion(productId, checked) {
            if (!recipeImpactState) return;
            const id = Number(productId);
            if (!Number.isFinite(id)) return;
            if (checked) recipeImpactState.excludedIds.add(id);
            else recipeImpactState.excludedIds.delete(id);
            renderRecipeImpactModal();
        }

        function renderRecipeImpactModal() {
            if (!recipeImpactState) return;
            const subtitle = document.getElementById('recipeImpactSubtitle');
            const body = document.getElementById('recipeImpactBody');
            const summary = document.getElementById('recipeImpactSummary');
            if (!subtitle || !body || !summary) return;

            const total = recipeImpactState.affectedEntries.length;
            const excluded = recipeImpactState.excludedIds.size;
            const willUpdate = Math.max(0, total - excluded);

            subtitle.textContent = `ÂΩìÂâçÂïÜÂìÅ‰ºöÁõ¥Êé•Êõ¥Êñ∞„ÄÇ‰ª•‰∏ã‰∏∫ÂÖ≥ËÅîÂïÜÂìÅÔºöÂãæÈÄâÂêé‰øùÊåÅÂéüÈÖçÊñπ‰∏çÂèò`;
            summary.textContent = `ÂÖ≥ËÅîÂïÜÂìÅÂ∞ÜÊõ¥Êñ∞ ${willUpdate} ‰∏™ÔºåÊéíÈô§ ${excluded} ‰∏™`;

            if (!total) {
                body.innerHTML = '<div class="recipe-impact-empty">Ê≤°ÊúâÂÖ≥ËÅîÂïÜÂìÅÂèóÂΩ±ÂìçÔºåÁ°ÆËÆ§Âêé‰ªÖÊõ¥Êñ∞ÂΩìÂâçÂïÜÂìÅ</div>';
                return;
            }

            body.innerHTML = recipeImpactState.affectedEntries.map(item => {
                const checked = recipeImpactState.excludedIds.has(item.id);
                return `
                    <label class="recipe-impact-item">
                        <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleRecipeImpactExclusion('${item.id}', this.checked)">
                        <div class="recipe-impact-item-body">
                            <div class="recipe-impact-item-name">
                                ${escAttr(item.name)}
                            </div>
                            <div class="recipe-impact-item-meta">ID: ${item.id} ¬∑ ÂàÜÁ±ª: ${escAttr(item.categoryName)}</div>
                        </div>
                    </label>
                `;
            }).join('');
        }

        function persistRecipeChanges(changedProducts = []) {
            if (!Array.isArray(changedProducts) || !changedProducts.length) return;
            let edits = {};
            try {
                edits = JSON.parse(localStorage.getItem('menuProductEdits') || '{}');
            } catch (e) {
                edits = {};
            }

            changedProducts.forEach(product => {
                if (!product || typeof product !== 'object') return;
                const id = Number(product.id);
                if (!Number.isFinite(id)) return;
                edits[id] = product;
                if (productData && Number(productData.id) === id) {
                    productData = product;
                }
            });

            localStorage.setItem('menuProductEdits', JSON.stringify(edits));
        }

        function confirmRecipeImpactApply() {
            if (!recipeImpactState) return;
            const total = recipeImpactState.affectedEntries.length;
            const excluded = recipeImpactState.excludedIds.size;
            const updatedCount = Math.max(0, total - excluded);
            const excludedIds = recipeImpactState.excludedIds;
            const changedProducts = [];
            const currentProductId = Number(productData?.id);

            if (productData && Number.isFinite(currentProductId)) {
                setOptionRecipeLinkId(
                    recipeImpactState.specKey,
                    recipeImpactState.tagKey,
                    recipeImpactState.linkId,
                    productData
                );
                setOptionRecipe(
                    recipeImpactState.specKey,
                    recipeImpactState.tagKey,
                    recipeImpactState.recipe,
                    recipeImpactState.tagLabel,
                    productData
                );
                changedProducts.push(productData);
            }

            recipeImpactState.affectedEntries.forEach(item => {
                const product = item.product;
                if (!product) return;
                if (excludedIds.has(item.id)) {
                    const isolatedLinkId = buildUniqueRecipeLinkId(recipeImpactState.specKey, recipeImpactState.tagKey, item.id);
                    setOptionRecipeLinkId(recipeImpactState.specKey, recipeImpactState.tagKey, isolatedLinkId, product);
                    changedProducts.push(product);
                    return;
                }
                setOptionRecipeLinkId(recipeImpactState.specKey, recipeImpactState.tagKey, recipeImpactState.linkId, product);
                setOptionRecipe(
                    recipeImpactState.specKey,
                    recipeImpactState.tagKey,
                    recipeImpactState.recipe,
                    item.tagLabel,
                    product
                );
                changedProducts.push(product);
            });

            persistRecipeChanges(changedProducts);
            closeRecipeImpactModal();
            closeRecipeEditor();
            showToast(`ÈÖçÊñπÂ∑≤‰øùÂ≠òÔºåÂ∑≤Êõ¥Êñ∞ÂΩìÂâçÂïÜÂìÅ + ${updatedCount} ‰∏™ÂÖ≥ËÅîÂïÜÂìÅ`);
        }

        function openRecipeEditor(specKey) {
            if (!productData) return;
            const optionInfo = getSelectedOptionInfo(specKey);
            if (!optionInfo) {
                showToast('ËØ∑ÂÖàÂú®ËØ•ÂàÜÁªÑÈÄâÊã©‰∏Ä‰∏™ÈÄâÈ°π', 'error');
                return;
            }

            recipeEditorState = {
                specKey: optionInfo.specKey,
                tagKey: optionInfo.tagKey,
                tagLabel: optionInfo.tagLabel,
                recipe: getOptionRecipe(optionInfo.specKey, optionInfo.tagKey, optionInfo.tagLabel)
            };

            renderRecipeEditor();
            document.getElementById('recipeEditorModal').classList.add('active');
        }

        function closeRecipeEditor() {
            const modal = document.getElementById('recipeEditorModal');
            if (modal) modal.classList.remove('active');
            recipeEditorState = null;
        }

        function renderRecipeEditor() {
            if (!recipeEditorState) return;
            const body = document.getElementById('recipeEditorBody');
            const subtitle = document.getElementById('recipeEditorSubtitle');
            if (!body || !subtitle) return;

            const cfg = getTagConfigBySpec(recipeEditorState.specKey);
            const specTitle = cfg ? cfg.title : recipeEditorState.specKey;
            subtitle.textContent = `${specTitle} ¬∑ ${recipeEditorState.tagLabel}`;

            body.innerHTML = recipeEditorState.recipe.groupOrder.map((groupKey, index) => {
                const groupCfg = getRecipeGroupConfig(groupKey);
                if (!groupCfg) return '';
                const groupData = recipeEditorState.recipe.groups[groupKey] || { names: [], percent: 100 };
                const recipeNames = formatRecipeGroupNames(groupData.names, groupCfg.multi);

                return `
                    <div class="recipe-group-card">
                        <div class="recipe-group-top">
                            <div class="recipe-group-title">${groupCfg.title}</div>
                            <div class="recipe-group-controls">
                                <button type="button" class="recipe-control-btn" onclick="moveRecipeGroup('${groupKey}', -1)" ${index === 0 ? 'disabled' : ''}>‰∏äÁßª</button>
                                <button type="button" class="recipe-control-btn" onclick="moveRecipeGroup('${groupKey}', 1)" ${index === recipeEditorState.recipe.groupOrder.length - 1 ? 'disabled' : ''}>‰∏ãÁßª</button>
                                <button type="button" class="recipe-control-btn" onclick="adjustRecipeGroupPercent('${groupKey}', -10)">-10%</button>
                                <span class="recipe-group-percent">${normalizeRecipePercent(groupData.percent)}%</span>
                                <button type="button" class="recipe-control-btn" onclick="adjustRecipeGroupPercent('${groupKey}', 10)">+10%</button>
                            </div>
                        </div>
                        <div class="recipe-group-field">
                            <label class="recipe-group-field-label">${groupCfg.multi ? 'ÂéüÊñôÂêçÁß∞ÔºàÂ§ö‰∏™Ôºâ' : 'ÂéüÊñôÂêçÁß∞'}</label>
                            <div class="recipe-group-value">${escAttr(recipeNames)}</div>
                            <div class="recipe-group-hint">ÂêçÁß∞Âú®ÂΩìÂâçÈÄâÈ°πÈáåÂè™ËØªÂ±ïÁ§∫ÔºåÂ¶ÇÈúÄÊîπÂêçÁß∞ËØ∑Ëµ∞Ê†áÁ≠æÈÖçÁΩÆ„ÄÇ</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function moveRecipeGroup(groupKey, delta) {
            if (!recipeEditorState) return;
            const order = recipeEditorState.recipe.groupOrder;
            const index = order.indexOf(groupKey);
            if (index < 0) return;
            const target = index + Number(delta);
            if (target < 0 || target >= order.length) return;
            const next = [...order];
            [next[index], next[target]] = [next[target], next[index]];
            recipeEditorState.recipe.groupOrder = next;
            renderRecipeEditor();
        }

        function adjustRecipeGroupPercent(groupKey, delta) {
            if (!recipeEditorState) return;
            const group = recipeEditorState.recipe.groups[groupKey];
            if (!group) return;
            group.percent = normalizeRecipePercent((Number(group.percent) || 100) + Number(delta || 0));
            renderRecipeEditor();
        }

        function saveRecipeEditor() {
            if (!recipeEditorState || !productData) return;
            const linkId = getOptionRecipeLinkId(
                recipeEditorState.specKey,
                recipeEditorState.tagKey,
                productData
            );
            const affectedEntries = getRecipeImpactEntries(
                recipeEditorState.specKey,
                recipeEditorState.tagKey,
                linkId
            );

            recipeImpactState = {
                specKey: recipeEditorState.specKey,
                tagKey: recipeEditorState.tagKey,
                specTitle: getTagConfigBySpec(recipeEditorState.specKey)?.title || recipeEditorState.specKey,
                tagLabel: recipeEditorState.tagLabel,
                linkId,
                recipe: normalizeRecipeData(recipeEditorState.recipe, recipeEditorState.tagLabel),
                affectedEntries,
                excludedIds: new Set()
            };

            openRecipeImpactModal();
        }

        function escAttr(v) {
            return String(v || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function initPage() {
            switchProductDetailTab('basic');
            // Ëß£Êûê URL ÂèÇÊï∞
            const params = new URLSearchParams(window.location.search);
            const detailTab = params.get('detailTab');
            const payloadKey = params.get('payloadKey');
            const payloadStore = params.get('payloadStore');
            const productJson = params.get('product');
            const categoryJson = params.get('category');
            const productId = Number(params.get('id'));
            currentDevice = params.get('device') || 'RCK111';
            if (detailTab === 'recipe') {
                switchProductDetailTab('recipe');
            }

            if (payloadKey) {
                try {
                    const rawPayload = sessionStorage.getItem(`productDetailPayload:${payloadKey}`);
                    if (rawPayload) {
                        const payload = JSON.parse(rawPayload);
                        if (payload && payload.product) {
                            productData = payload.product;
                        }
                        if (payload && payload.category) {
                            categoryNames = payload.category;
                        }
                        if (payload && Array.isArray(payload.catalog)) {
                            linkedProductCatalog = payload.catalog;
                        }
                    }
                } catch (e) {
                    console.error('ËØªÂèñ‰ºöËØùÂïÜÂìÅÊï∞ÊçÆÂ§±Ë¥•', e);
                }
            }

            if (!productData && payloadKey && payloadStore === 'windowName') {
                try {
                    const rawWindowPayload = window.name || '';
                    if (rawWindowPayload) {
                        const wrapped = JSON.parse(rawWindowPayload);
                        if (wrapped && wrapped.__type === 'productDetailPayload' && wrapped.payloadKey === payloadKey) {
                            if (wrapped.payload && wrapped.payload.product) {
                                productData = wrapped.payload.product;
                            }
                            if (wrapped.payload && wrapped.payload.category) {
                                categoryNames = wrapped.payload.category;
                            }
                            if (wrapped.payload && Array.isArray(wrapped.payload.catalog)) {
                                linkedProductCatalog = wrapped.payload.catalog;
                            }
                        }
                    }
                } catch (e) {
                    console.error('ËØªÂèñ window.name ÂïÜÂìÅÊï∞ÊçÆÂ§±Ë¥•', e);
                }
            }

            if (!productData && productJson) {
                try {
                    productData = JSON.parse(decodeURIComponent(productJson));
                } catch (e) {
                    console.error('Ëß£ÊûêÂïÜÂìÅÊï∞ÊçÆÂ§±Ë¥•', e);
                }
            }

            if (!productData && Number.isFinite(productId)) {
                try {
                    const edits = JSON.parse(localStorage.getItem('menuProductEdits') || '{}');
                    if (edits && edits[productId]) {
                        productData = edits[productId];
                    }
                } catch (e) {
                    console.error('ËØªÂèñÊú¨Âú∞ÂïÜÂìÅÁºñËæëÊï∞ÊçÆÂ§±Ë¥•', e);
                }
            }

            if ((!categoryNames || Object.keys(categoryNames).length === 0) && categoryJson) {
                try {
                    categoryNames = JSON.parse(decodeURIComponent(categoryJson));
                } catch (e) {
                    console.error('Ëß£ÊûêÂàÜÁ±ªÊï∞ÊçÆÂ§±Ë¥•', e);
                }
            }

            if (productData) {
                document.getElementById('productId').textContent = 'ID: ' + productData.id;
                if (!Array.isArray(linkedProductCatalog) || linkedProductCatalog.length === 0) {
                    linkedProductCatalog = [{
                        id: productData.id,
                        category: categoryNames,
                        product: productData
                    }];
                }
                renderMultiLangInputs();
                fillFormData();
            }

            // ÂõæÁâáËæìÂÖ•ÁõëÂê¨
            document.getElementById('productImage').addEventListener('input', updateImagePreview);
            document.getElementById('productImageFile').addEventListener('change', handleProductImageFileChange);
            document.getElementById('onSaleSwitch').addEventListener('change', updateOnSaleLabel);
            document.getElementById('productPrice').addEventListener('input', updatePricePreview);
            document.getElementById('productOriginalPrice').addEventListener('input', updatePricePreview);
            document.getElementById('productCurrency').addEventListener('change', updatePricePreview);

            // ÈÄâÈ°πÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.option-list').forEach(list => {
                list.addEventListener('click', function(e) {
                    if (e.target.classList.contains('option-item')) {
                        this.querySelectorAll('.option-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        e.target.classList.add('selected');

                        const meta = tagConfigs.find(cfg => cfg.listId === this.id);
                        if (meta) {
                            if (!e.target.dataset.tagKey) e.target.dataset.tagKey = e.target.dataset.value;
                            setSpec(currentLang, { [meta.specKey]: e.target.dataset.tagKey });
                            setActiveRecipeSpec(meta.specKey);
                            if (drawerActiveSpecKey === meta.specKey) {
                                drawerSelectedTagKey = e.target.dataset.tagKey;
                            }
                        }
                    }
                });
            });

            document.querySelectorAll('.option-card[data-spec-key]').forEach(card => {
                card.addEventListener('click', function() {
                    setActiveRecipeSpec(card.dataset.specKey);
                });
            });

            setActiveRecipeSpec(activeRecipeSpecKey);

            const recipeModal = document.getElementById('recipeEditorModal');
            if (recipeModal) {
                recipeModal.addEventListener('click', function(e) {
                    if (e.target === recipeModal) closeRecipeEditor();
                });
            }

            const recipeImpactModal = document.getElementById('recipeImpactModal');
            if (recipeImpactModal) {
                recipeImpactModal.addEventListener('click', function(e) {
                    if (e.target === recipeImpactModal) closeRecipeImpactModal();
                });
            }

            document.addEventListener('keydown', function(e) {
                if (e.key !== 'Escape') return;
                const drawer = document.getElementById('tagConfigDrawer');
                if (drawer && drawer.classList.contains('active')) {
                    closeTagConfigDrawer();
                    return;
                }
                const impact = document.getElementById('recipeImpactModal');
                if (impact && impact.classList.contains('active')) {
                    closeRecipeImpactModal();
                    return;
                }
                const modal = document.getElementById('recipeEditorModal');
                if (modal && modal.classList.contains('active')) {
                    closeRecipeEditor();
                }
            });
        }

        function renderMultiLangInputs() {
            const container = document.getElementById('multiLangInputs');
            const langs = getDeviceLangs();

            container.innerHTML = langs.map(lang => `
                <div class="lang-section">
                    <div class="lang-section-header">
                        <span class="lang-section-title">ÂïÜÂìÅ‰ø°ÊÅØ</span>
                        <span class="lang-section-badge">${getLangName(lang)}</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂïÜÂìÅÂêçÁß∞ ${lang === langs[0] ? '<span class="required">*</span>' : ''}</label>
                        <input type="text" class="form-input product-name-${lang}" value="${productData.names?.[lang] || ''}" placeholder="ËØ∑ËæìÂÖ•${getLangName(lang)}ÂêçÁß∞">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">ÂïÜÂìÅÊèèËø∞</label>
                        <textarea class="form-textarea product-desc-${lang}" placeholder="ËØ∑ËæìÂÖ•${getLangName(lang)}ÊèèËø∞" style="min-height: 60px;">${productData.descs?.[lang] || ''}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function fillFormData() {
            // ÂàÜÁ±ªÂêçÁß∞ÔºàÊòæÁ§∫ÂΩìÂâçËØ≠Ë®ÄÔºâ
            document.getElementById('categoryName').value = categoryNames[currentLang] || categoryNames['zh'] || categoryNames['en'] || '--';
            
            // ÂõæÁâá
            document.getElementById('productImage').value = productData.image || '';
            updateImagePreview();
            
            // ‰ª∑Ê†º
            document.getElementById('productPrice').value = productData.price || '';
            document.getElementById('productOriginalPrice').value = productData.originalPrice || '';
            document.getElementById('productCurrency').value = normalizeCurrency(productData.currency);
            updatePricePreview();
            
            // Êé®ËçêÂºÄÂÖ≥
            document.getElementById('featuredSwitch').checked = productData.featured !== false;
            document.getElementById('onSaleSwitch').checked = productData.onSale !== false;
            updateOnSaleLabel();

            tagConfigs.forEach(meta => {
                ensureTagI18n(meta.specKey);
                refreshOptionListLabels(meta.specKey);
                const spec = getSpec(currentLang);
                const preferred = getDefaultOption(meta.specKey) || resolveTagKey(meta.specKey, spec[meta.specKey]) || resolveTagKey(meta.specKey, productData.options?.[meta.optionTitle]);
                if (preferred) {
                    syncSelectedOption(meta.listId, preferred);
                    setSpec(currentLang, { [meta.specKey]: preferred });
                }
            });
        }

        function updateImagePreview() {
            const previewContainer = document.getElementById('productImagePreview');
            const imageUrl = document.getElementById('productImage').value.trim();
            
            if (imageUrl) {
                previewContainer.innerHTML = `
                    <div style="width: 200px; height: 150px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                        <img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:13px;\\'>ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</div>'">
                    </div>
                `;
            } else {
                previewContainer.innerHTML = `
                    <div style="width: 200px; height: 150px; border-radius: 8px; background: #f5f7fa; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-size: 13px;">
                        <span style="font-size: 36px; margin-bottom: 8px;">‚òï</span>
                        <span>ÊöÇÊó†ÂõæÁâá</span>
                    </div>
                `;
            }
        }

        function handleProductImageFileChange(event) {
            const input = event && event.target;
            const file = input && input.files && input.files[0];
            if (!file) return;

            if (!file.type || !file.type.startsWith('image/')) {
                showToast('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂', 'error');
                input.value = '';
                return;
            }

            const maxSize = 6 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('ÂõæÁâáËøáÂ§ßÔºåËØ∑ÈÄâÊã© 6MB ‰ª•ÂÜÖÂõæÁâá', 'error');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(loadEvent) {
                const result = loadEvent && loadEvent.target ? loadEvent.target.result : '';
                if (!result || typeof result !== 'string') {
                    showToast('ÂõæÁâáËØªÂèñÂ§±Ë¥•', 'error');
                    input.value = '';
                    return;
                }
                document.getElementById('productImage').value = result;
                updateImagePreview();
                showToast('Êú¨Âú∞ÂõæÁâáÂ∑≤Âä†ËΩΩ');
                input.value = '';
            };
            reader.onerror = function() {
                showToast('ÂõæÁâáËØªÂèñÂ§±Ë¥•', 'error');
                input.value = '';
            };
            reader.readAsDataURL(file);
        }

        function getSelectedOptions() {
            const options = {};
            const titles = ['BEAN', 'TEMPERATURE', 'PROFILE', 'SYRUP', 'SWEETNESS', 'CUPSIZE', 'LID', 'LATTE-ART'];
            const ids = ['beanOptions', 'tempOptions', 'profileOptions', 'syrupOptions', 'sweetnessOptions', 'cupsizeOptions', 'lidOptions', 'latteArtOptions'];
            
            ids.forEach((id, index) => {
                const selected = document.querySelector(`#${id} .option-item.selected`);
                options[titles[index]] = selected ? selected.dataset.value : '';
            });
            
            return options;
        }

        function renderTagTree() {
            const tree = document.getElementById('tagTree');
            tree.innerHTML = tagConfigs.map(cfg => `
                <button class="tag-tree-item ${cfg.specKey === drawerActiveSpecKey ? 'active' : ''}" onclick="switchDrawerTag('${cfg.specKey}')">
                    ${cfg.title}
                </button>
            `).join('');
        }

        function renderDrawerEditor() {
            const cfg = getTagConfigBySpec(drawerActiveSpecKey);
            if (!cfg) return;
            const langs = getDeviceLangs();
            const container = document.getElementById('tagDrawerEditor');
            document.getElementById('tagDrawerTitle').textContent = `${cfg.title}Ê†áÁ≠æÈÖçÁΩÆ`;
            ensureTagI18n(cfg.specKey);
            refreshOptionListLabels(cfg.specKey);

            const tagKeys = getTagKeys(cfg.specKey);
            if (!drawerSelectedTagKey || !tagKeys.includes(drawerSelectedTagKey)) {
                drawerSelectedTagKey = getCurrentSelectedTagKey(cfg.specKey) || tagKeys[0] || '';
            }
            const currentDefault = getDefaultOption(cfg.specKey);

            let html = `<div class="existing-tag-helper">Áé∞ÊúâÊ†áÁ≠æÔºàÁÇπÂáªÈÄâÊã©‰∏Ä‰∏™ËøõË°åÁºñËæëÔºâ</div>`;
            html += `<div class="existing-tags">`;
            html += tagKeys.map(tagKey => `
                <button class="existing-tag-item ${tagKey === drawerSelectedTagKey ? 'active' : ''}" onclick="selectDrawerTag('${tagKey}')">
                    ${getTagLabel(cfg.specKey, tagKey, currentLang)}
                </button>
            `).join('');
            html += `</div>`;

            html += langs.map(lang => `
                <div class="lang-section">
                    <div class="lang-section-header">
                        <span class="lang-section-title">${cfg.title}Ê†áÁ≠æ</span>
                        <span class="lang-section-badge">${getLangName(lang)}</span>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Ê†áÁ≠æÂÜÖÂÆπ</label>
                        <input type="text" class="form-input drawer-tag-lang-${lang}" value="${escAttr(getTagLabel(cfg.specKey, drawerSelectedTagKey, lang))}" placeholder="ËØ∑ËæìÂÖ•${getLangName(lang)}${cfg.title}Ê†áÁ≠æ">
                    </div>
                </div>
            `).join('');

            html += `
                <div class="tag-default-wrap">
                    <label class="tag-default-check">
                        <input type="checkbox" id="drawerTagDefaultSingle" ${(currentDefault && currentDefault === drawerSelectedTagKey) ? 'checked' : ''}>
                        <span class="tag-default-box"></span>
                        <span class="tag-default-text">ÂÆ¢Êà∑Ë¥≠‰π∞Êó∂ÈªòËÆ§ÈÄâ‰∏≠</span>
                    </label>
                </div>
            `;
            container.innerHTML = html;
        }

        function persistDrawerCurrentTag() {
            const cfg = getTagConfigBySpec(drawerActiveSpecKey);
            if (!cfg || !drawerSelectedTagKey) return;
            const langs = getDeviceLangs();
            langs.forEach(lang => {
                const el = document.querySelector('.drawer-tag-lang-' + lang);
                const val = el ? el.value.trim() : '';
                ensureTagI18n(cfg.specKey);
                if (!productData.tagI18n[cfg.specKey][drawerSelectedTagKey]) productData.tagI18n[cfg.specKey][drawerSelectedTagKey] = {};
                if (val) productData.tagI18n[cfg.specKey][drawerSelectedTagKey][lang] = val;
                else delete productData.tagI18n[cfg.specKey][drawerSelectedTagKey][lang];
            });

            const shouldDefault = !!(document.getElementById('drawerTagDefaultSingle') && document.getElementById('drawerTagDefaultSingle').checked);
            if (shouldDefault) setDefaultOption(cfg.specKey, drawerSelectedTagKey);
            if (!shouldDefault) setDefaultOption(cfg.specKey, '');

            refreshOptionListLabels(cfg.specKey);
            const selectedKey = getCurrentSelectedTagKey(cfg.specKey);
            const effectiveKey = getDefaultOption(cfg.specKey) || selectedKey || drawerSelectedTagKey;
            if (effectiveKey) {
                syncSelectedOption(cfg.listId, effectiveKey);
                setSpec(currentLang, { [cfg.specKey]: effectiveKey });
            }
        }

        function selectDrawerTag(tagKey) {
            persistDrawerCurrentTag();
            drawerSelectedTagKey = tagKey;
            renderDrawerEditor();
        }

        function switchDrawerTag(specKey) {
            persistDrawerCurrentTag();
            drawerActiveSpecKey = specKey;
            drawerSelectedTagKey = getCurrentSelectedTagKey(specKey) || getTagKeys(specKey)[0] || '';
            renderTagTree();
            renderDrawerEditor();
        }

        function openTagConfigDrawer(initialSpecKey = 'beans') {
            drawerActiveSpecKey = initialSpecKey;
            drawerSelectedTagKey = getCurrentSelectedTagKey(initialSpecKey) || getTagKeys(initialSpecKey)[0] || '';
            renderTagTree();
            renderDrawerEditor();
            document.getElementById('tagConfigDrawer').classList.add('active');
        }

        function closeTagConfigDrawer() {
            document.getElementById('tagConfigDrawer').classList.remove('active');
        }

        function saveTagConfigDrawer() {
            persistDrawerCurrentTag();
            closeTagConfigDrawer();
            showToast('Ê†áÁ≠æÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞');
        }

        function saveProduct() {
            if (!productData) return;

            const langs = getDeviceLangs();
            const firstLang = langs[0];

            // È™åËØÅ‰∏ªËØ≠Ë®ÄÂêçÁß∞
            const firstName = document.querySelector('.product-name-' + firstLang).value.trim();
            if (!firstName) {
                showToast(`ËØ∑ËæìÂÖ•${getLangName(firstLang)}ÂïÜÂìÅÂêçÁß∞`, 'error');
                return;
            }

            const price = parseFloat(document.getElementById('productPrice').value);
            if (!price || price <= 0) {
                showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ª∑Ê†º', 'error');
                return;
            }

            const originalPriceRaw = document.getElementById('productOriginalPrice').value.trim();
            let originalPrice = null;
            if (originalPriceRaw) {
                const parsedOriginalPrice = parseFloat(originalPriceRaw);
                if (!Number.isFinite(parsedOriginalPrice) || parsedOriginalPrice <= 0) {
                    showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂéü‰ª∑', 'error');
                    return;
                }
                if (parsedOriginalPrice <= price) {
                    showToast('Âéü‰ª∑ÈúÄÂ§ß‰∫éÂïÜÂìÅ‰ª∑Ê†º', 'error');
                    return;
                }
                originalPrice = parsedOriginalPrice;
            }

            const currency = normalizeCurrency(document.getElementById('productCurrency').value);

            // Êî∂ÈõÜÂ§öËØ≠Ë®ÄÊï∞ÊçÆ
            const names = {};
            const descs = {};
            
            langs.forEach(lang => {
                const nameEl = document.querySelector('.product-name-' + lang);
                const descEl = document.querySelector('.product-desc-' + lang);
                
                if (nameEl && nameEl.value.trim()) {
                    names[lang] = nameEl.value.trim();
                }
                if (descEl && descEl.value.trim()) {
                    descs[lang] = descEl.value.trim();
                }
            });

            // ÂõæÁâá
            const image = document.getElementById('productImage').value.trim();

            // Êõ¥Êñ∞ÂïÜÂìÅÊï∞ÊçÆ
            const updatedProduct = {
                ...productData,
                names: names,
                descs: descs,
                image: image || null,
                price: price,
                originalPrice: originalPrice,
                currency: currency,
                featured: document.getElementById('featuredSwitch').checked,
                onSale: document.getElementById('onSaleSwitch').checked,
                specs: productData.specs || {},
                defaultOptions: productData.defaultOptions || {},
                optionRecipes: productData.optionRecipes || {},
                optionRecipeLinks: productData.optionRecipeLinks || {},
                options: getSelectedOptions()
            };

            const edits = JSON.parse(localStorage.getItem('menuProductEdits') || '{}');
            edits[updatedProduct.id] = updatedProduct;
            localStorage.setItem('menuProductEdits', JSON.stringify(edits));

            showToast('ÂïÜÂìÅÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');

            // ËøîÂõûËèúÂçïÈ°µ
            setTimeout(() => {
                goBack();
            }, 800);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        function goBack() {
            window.location.href = 'menu-management.html?tab=menu&innerTab=manage';
        }

        function goTo(url) {
            window.location.href = url;
        }

        window.onload = initPage;
    </script>
</body>
</html>
