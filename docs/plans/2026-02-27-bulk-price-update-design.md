# 批量改固定价功能设计（菜单管理）

> 日期：2026-02-27  
> 页面：`/Users/tigerhuang/cofeplus/menu-management.html`

## 1. 背景与目标
当前商品价格调整需要逐个进入详情页，操作成本高且容易漏改。目标是在菜单管理页提供“按分类 + 手动勾选 + 全选”的批量改固定价能力，显著降低运营改价成本。

## 2. 目标范围
- 在商品管理页增加“批量改价”模式入口。
- 按分类选择商品，支持单选、全选、取消全选。
- 批量设置“现价（必填）+ 原价（选填）”。
- 支持部分成功提交：单条失败不阻塞其余条目。
- 失败条目保留选中，可直接重试。
- 成功条目自动取消选中，并显示“修改成功”行样式。
- 成功样式仅在当前批量模式会话内有效，退出即清除。

## 3. 非目标
- 不做 Excel/CSV 导入。
- 不做按百分比或按金额自动换算。
- 不做跨页面全局事务回滚。
- 不做后端接口联调（当前页面为前端本地数据模型）。

## 4. 核心业务规则
1. 操作对象为用户手动勾选的商品，支持“全选当前分类”。
2. 现价必填且必须 `> 0`。
3. 原价可不填：留空表示“不修改原价”。
4. 若填写原价，必须满足 `原价 > 现价`，否则阻止执行并提示。
5. 提交执行采用逐条处理：
   - 单条成功：立即落地并更新界面。
   - 单条失败：记录失败原因并继续处理后续条目。
6. 提交完成后展示 `成功 X / 失败 Y`，并提供“重试失败项”。

## 5. 交互设计
## 5.1 入口与模式
- 在菜单管理页头部操作区新增“批量改价”按钮。
- 点击后进入批量模式，商品卡显示勾选控件。
- 再次点击“退出批量”离开模式并清除本次成功样式。

## 5.2 批量操作面板
面板字段：
- 分类选择（下拉）
- 现价输入（必填）
- 原价输入（选填）
- 已选数量
- 操作按钮：`提交改价`、`重试失败项`

## 5.3 商品行状态
- `selected`：当前勾选
- `success`：本轮提交成功（行高亮 + 成功标签）
- `failed`：本轮提交失败（错误提示/失败标签）

状态切换：
- 成功后：自动取消选中 + 标记 success。
- 失败后：保留选中 + 标记 failed。

## 6. 数据设计
新增批量模式运行态（仅内存）：
- `isBatchPriceMode`：是否批量模式
- `batchSelectedIds`：已选商品ID集合
- `batchSuccessIds`：本会话成功ID集合
- `batchFailedMap`：失败映射 `{ [id]: reason }`
- `batchActiveCategory`：当前操作分类

持久化策略：
- 成功条目同步更新 `productsData`。
- 成功条目写入 `localStorage.menuProductEdits`，保证刷新后可恢复。
- 失败条目不写入。

## 7. 执行流程
1. 用户进入批量模式并选择分类。
2. 勾选若干商品（或全选）。
3. 输入现价与可选原价。
4. 点击提交，先做全局输入校验。
5. 校验通过后逐条执行，记录成功/失败。
6. 展示汇总与失败清单。
7. 用户可点击“重试失败项”再次提交失败条目。

## 8. 错误处理
- 未选择商品：阻止提交并提示“请先选择商品”。
- 现价非法：阻止提交并提示“请输入有效现价”。
- 原价关系非法：阻止提交并提示“原价需大于现价”。
- 单条执行异常（例如数据异常、存储异常）：
  - 当前条目标记失败，记录错误原因。
  - 不中断后续条目执行。

## 9. 可观测性与反馈
- Toast 展示汇总结果：`批量改价完成：成功 X，失败 Y`。
- 面板展示失败明细（商品名、失败原因）。
- 行级视觉反馈：成功/失败标签。

## 10. 验收标准
1. 支持手动勾选与全选当前分类。
2. 支持现价必填、原价选填，不填原价不改原价。
3. 原价填写但 `<= 现价` 时阻止提交。
4. 提交支持部分成功，失败不阻塞其余项。
5. 成功项自动取消选中并显示成功样式。
6. 失败项保留选中并可“重试失败项”。
7. 退出批量模式后，成功样式清除。
8. 刷新后成功修改可通过 `menuProductEdits` 恢复。
