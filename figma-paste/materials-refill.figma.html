<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ·»åŠ ç‰©æ–™ - è¿è¥æ§åˆ¶å°</title>
    <meta name="format-detection" content="telephone=no">
    <style>
        :root {
            --primary: #4ecdc4;
            --primary-dark: #3dbdb4;
            --primary-light: #e8f8f7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --bg-body: #f5f5f5;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: #fff;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            height: 50px;
        }

        .back-btn {
            position: absolute;
            left: 12px;
            font-size: 20px;
            cursor: pointer;
            color: #333;
            padding: 8px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        /* ä¸»å¸ƒå±€ */
        .main-container {
            display: flex;
            height: calc(100vh - 50px - 70px);
            overflow: hidden;
        }

        /* å·¦ä¾§åˆ†ç±»æ  */
        .category-sidebar {
            width: 100px;
            background: #f8f8f8;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .category-item {
            padding: 16px 12px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            text-align: center;
            line-height: 1.4;
        }

        .category-item:hover {
            background: #f0f0f0;
        }

        .category-item.active {
            background: #fff;
            color: var(--primary-dark);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        /* å³ä¾§ç‰©æ–™åˆ—è¡¨ */
        .material-list {
            flex: 1;
            overflow-y: auto;
            background: #fff;
            padding-bottom: 20px;
        }

        .category-section {
            padding: 12px 16px;
        }

        .category-divider {
            text-align: center;
            padding: 16px 0;
            color: var(--text-tertiary);
            font-size: 13px;
            position: relative;
        }

        .category-divider::before,
        .category-divider::after {
            content: '*';
            margin: 0 8px;
            color: #ddd;
        }

        .material-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #f5f5f5;
            background: #fff;
        }

        .material-info {
            flex: 1;
            min-width: 0;
        }

        .material-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .material-stock {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* æ•°é‡è°ƒèŠ‚å™¨ */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .qty-btn.minus {
            border-radius: 4px 0 0 4px;
            border-right: none;
        }

        .qty-btn.plus {
            border-radius: 0 4px 4px 0;
            border-left: none;
            color: var(--primary);
        }

        .qty-btn:hover {
            background: #f8f8f8;
        }

        .qty-btn:active {
            background: #f0f0f0;
        }

        .qty-btn.plus:hover {
            background: var(--primary-light);
        }

        .qty-input {
            width: 50px;
            height: 32px;
            border: 1px solid var(--border);
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            outline: none;
            -moz-appearance: textfield;
        }

        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .selected-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .selected-count {
            color: var(--primary);
            font-weight: 700;
            font-size: 16px;
        }

        .complete-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 32px;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }

        .complete-btn:hover {
            background: var(--primary-dark);
        }

        .complete-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--primary);
        }

        /* é€‰ä¸­ç‰©æ–™å±•å¼€é¢æ¿ */
        .selected-panel {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background: #fff;
            border-top: 1px solid var(--border);
            max-height: 50vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 99;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
        }

        .selected-panel.show {
            transform: translateY(0);
        }

        .selected-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .selected-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .selected-panel-close {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .selected-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f5f5f5;
        }

        .selected-item-info {
            flex: 1;
        }

        .selected-item-name {
            font-size: 14px;
            color: var(--text-primary);
        }

        .selected-item-qty {
            font-size: 12px;
            color: var(--primary);
            margin-top: 2px;
        }

        .selected-item-remove {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .expand-hint {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 4px;
            color: var(--text-tertiary);
            font-size: 12px;
        }

        /* ç¡®è®¤å¼¹çª—æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            font-size: 18px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 140px);
        }

        .selected-summary {
            background: #f8f8f8;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            max-height: 150px;
            overflow-y: auto;
        }

        .summary-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item-name {
            color: var(--text-primary);
        }

        .summary-item-qty {
            color: var(--primary);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-label .required {
            color: var(--danger);
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            color: var(--text-primary);
            background: #fff;
            outline: none;
        }

        .form-input:focus,
        .form-textarea:focus {
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-footer {
            padding: 12px 20px 20px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .btn-default {
            background: #f5f5f5;
            color: var(--text-secondary);
        }

        .btn-confirm {
            background: var(--primary);
            color: #fff;
        }

        /* é®ç½©å±‚ */
        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 98;
        }

        .overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="header">
        <button class="back-btn" onclick="goBack()">â†</button>
        <h1 class="header-title">æ·»åŠ ç‰©æ–™</h1>
        <div class="device-info" id="headerDeviceInfo" style="position: absolute; right: 16px; font-size: 12px; color: var(--text-tertiary);">
            <!-- åŠ¨æ€æ˜¾ç¤ºè®¾å¤‡ -->
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <!-- å·¦ä¾§åˆ†ç±»æ  -->
        <aside class="category-sidebar" id="categorySidebar">
            <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç±» -->
        </aside>

        <!-- å³ä¾§ç‰©æ–™åˆ—è¡¨ -->
        <main class="material-list" id="materialList">
            <!-- åŠ¨æ€ç”Ÿæˆç‰©æ–™ -->
        </main>
    </div>

    <!-- å·²é€‰ç‰©æ–™é¢æ¿ -->
    <div class="overlay" id="overlay" onclick="toggleSelectedPanel()"></div>
    <div class="selected-panel" id="selectedPanel">
        <div class="selected-panel-header">
            <span class="selected-panel-title">å·²é€‰ç‰©æ–™</span>
            <button class="selected-panel-close" onclick="toggleSelectedPanel()">âœ•</button>
        </div>
        <div id="selectedList">
            <!-- åŠ¨æ€ç”Ÿæˆå·²é€‰ç‰©æ–™ -->
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="bottom-bar">
        <div class="selected-info">
            å·²é€‰æ‹© <span class="selected-count" id="selectedCount">0</span> ä¸ªç‰©æ–™
            <span class="expand-hint" id="expandHint" onclick="toggleSelectedPanel()" style="display: none;">
                å±•å¼€ â–¼
            </span>
        </div>
        <button class="complete-btn" id="completeBtn" onclick="completeRefill()">å®Œæˆ</button>
    </div>

    <!-- å‘è´§ç¡®è®¤å¼¹çª— -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ç¡®è®¤å‘è´§ä¿¡æ¯</h3>
                <button class="modal-close" onclick="closeConfirmModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="selected-summary" id="selectedSummary">
                    <!-- åŠ¨æ€æ˜¾ç¤ºå·²é€‰ç‰©æ–™ -->
                </div>
                <div class="form-group">
                    <label class="form-label">å‘è´§æ—¶é—´ <span class="required">*</span></label>
                    <input type="datetime-local" class="form-input" id="deliveryTime">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <textarea class="form-textarea" id="deliveryNote" placeholder="è¾“å…¥å‘è´§å¤‡æ³¨ä¿¡æ¯..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                <button class="btn btn-confirm" onclick="confirmDelivery()">ç”Ÿæˆå‘è´§å•</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <script>
        // ç‰©æ–™æ•°æ®ï¼ŒæŒ‰åˆ†ç±»ç»„ç»‡
        const materialsData = {
            'å¥¶&å’–å•¡&æ°´': [
                { name: "é²œç‰›å¥¶", code: "10010001", index: 1, remaining: 5000, unit: "ml", max: 10000 },
                { name: "å’–å•¡è±†", code: "10010002", index: 2, remaining: 2000, unit: "g", max: 5000 },
                { name: "çº¯å‡€æ°´", code: "10010003", index: 3, remaining: 15000, unit: "ml", max: 20000 },
            ],
            'ç³–æµ†': [
                { name: "ç”˜è”—å†°ç³–ç³–æµ†", code: "20010001", index: 11, remaining: 800, unit: "ml", max: 2000 },
                { name: "é¦™è‰é£å‘³ç³–æµ†", code: "20010002", index: 12, remaining: 600, unit: "ml", max: 2000 },
                { name: "æ¦›æœé£å‘³ç³–æµ†", code: "20010003", index: 13, remaining: 450, unit: "ml", max: 2000 },
                { name: "çƒ­çº¢é…’ç³–æµ†", code: "20010004", index: 14, remaining: 300, unit: "ml", max: 1000 },
            ],
            'å‰/åé“ç²‰': [
                { name: "å‰ç½®æŠ¹èŒ¶ç²‰", code: "74160100", index: 8, remaining: 135, unit: "g", max: 250 },
                { name: "å‰ç½®å¯å¯ç²‰", code: "74160200", index: 7, remaining: 435, unit: "g", max: 500 },
                { name: "æ¤°è“‰ä¸-4", code: "76150500", index: 27, remaining: 0, unit: "g", max: 500 },
                { name: "éº¦ç‰‡é¢—ç²’-2", code: "76190100", index: 25, remaining: 0, unit: "g", max: 500 },
                { name: "æ¦›æœé¢—ç²’-1", code: "76150200", index: 24, remaining: 0, unit: "g", max: 500 },
                { name: "é¦™è‰ç²‰-4", code: "74180100", index: 23, remaining: 0, unit: "g", max: 500 },
                { name: "ç‰æ¡‚ç²‰-1", code: "76170100", index: 20, remaining: 0, unit: "g", max: 500 },
                { name: "æŠ¹èŒ¶ç²‰-2", code: "74160101", index: 21, remaining: 0, unit: "g", max: 500 },
                { name: "å¯å¯ç²‰-3", code: "74150400", index: 22, remaining: 0, unit: "g", max: 500 },
            ],
            'åŒ…æ': [
                { name: "çº¸æ¯-16oz", code: "81020100", index: 5, remaining: 0, unit: "ä¸ª", max: 80 },
                { name: "çº¸æ¯-12oz", code: "81020101", index: 51, remaining: 60, unit: "ä¸ª", max: 80 },
                { name: "æ¯ç›–1", code: "83020300", index: 54, remaining: 100, unit: "ä¸ª", max: 100 },
                { name: "æ¯ç›–2", code: "83020301", index: 55, remaining: 80, unit: "ä¸ª", max: 100 },
                { name: "æ¯å¡ç›’", code: "83030100", index: 56, remaining: 200, unit: "ä¸ª", max: 500 },
                { name: "å¸ç®¡", code: "83040100", index: 57, remaining: 300, unit: "æ ¹", max: 500 },
                { name: "æ¯å¥—", code: "83050100", index: 58, remaining: 150, unit: "ä¸ª", max: 300 },
                { name: "çº¸è¢‹", code: "83060100", index: 59, remaining: 80, unit: "ä¸ª", max: 200 },
            ],
            'è¾…æ': [
                { name: "æ¸…æ´å¸ƒ", code: "91010100", index: 91, remaining: 20, unit: "æ¡", max: 50 },
                { name: "æ¶ˆæ¯’æ¹¿å·¾", code: "91010200", index: 92, remaining: 15, unit: "åŒ…", max: 30 },
                { name: "ä¸€æ¬¡æ€§æ‰‹å¥—", code: "91010300", index: 93, remaining: 8, unit: "ç›’", max: 20 },
                { name: "åƒåœ¾è¢‹", code: "91010400", index: 94, remaining: 5, unit: "å·", max: 10 },
            ],
            'è€—æ': [
                { name: "æ´—æœºè¯æ°´", code: "92010100", index: 81, remaining: 500, unit: "ml", max: 1000 },
                { name: "æ´—æœºè¯ä¸¸", code: "92010200", index: 82, remaining: 30, unit: "é¢—", max: 50 },
                { name: "é©±è™«è¯æ°´", code: "92010300", index: 83, remaining: 200, unit: "ml", max: 500 },
                { name: "è¿‡æ»¤æ£‰", code: "92010400", index: 84, remaining: 5, unit: "ç‰‡", max: 10 },
                { name: "å¯†å°åœˆ", code: "92010500", index: 85, remaining: 3, unit: "ä¸ª", max: 10 },
            ],
            'å¥¶ç²‰': [
                { name: "å…¨è„‚å¥¶ç²‰", code: "30010001", index: 31, remaining: 2000, unit: "g", max: 5000 },
                { name: "è„±è„‚å¥¶ç²‰", code: "30010002", index: 32, remaining: 1500, unit: "g", max: 5000 },
                { name: "ç‡•éº¦å¥¶", code: "30010003", index: 33, remaining: 800, unit: "ml", max: 2000 },
                { name: "æä»å¥¶", code: "30010004", index: 34, remaining: 600, unit: "ml", max: 2000 },
            ],
            'æ–™ç›’': [
                { name: "ç³–æµ†æ–™ç›’A", code: "40010001", index: 41, remaining: 1, unit: "ä¸ª", max: 2 },
                { name: "ç³–æµ†æ–™ç›’B", code: "40010002", index: 42, remaining: 1, unit: "ä¸ª", max: 2 },
                { name: "å¥¶ç²‰æ–™ç›’", code: "40010003", index: 43, remaining: 1, unit: "ä¸ª", max: 2 },
                { name: "ç²‰æ–™ç›’-1", code: "40010004", index: 44, remaining: 0, unit: "ä¸ª", max: 2 },
                { name: "ç²‰æ–™ç›’-2", code: "40010005", index: 45, remaining: 1, unit: "ä¸ª", max: 2 },
            ],
            'é£Ÿæ': [
                { name: "å†°", code: "10000005", index: 6, remaining: 4000, unit: "g", max: 4000 },
                { name: "æŸ æª¬ç‰‡", code: "50010001", index: 61, remaining: 20, unit: "ç‰‡", max: 50 },
                { name: "è–„è·å¶", code: "50010002", index: 62, remaining: 15, unit: "g", max: 30 },
                { name: "è‚‰æ¡‚æ£’", code: "50010003", index: 63, remaining: 10, unit: "æ ¹", max: 20 },
            ]
        };

        let currentCategory = 'å¥¶&å’–å•¡&æ°´';
        let selectedItems = {}; // { code: quantity }

        // åˆå§‹åŒ–
        function init() {
            // æ˜¾ç¤ºå½“å‰è®¾å¤‡
            const deviceId = getCurrentDevice();
            const location = getDeviceLocation(deviceId);
            document.getElementById('headerDeviceInfo').innerHTML = `${deviceId}<br><small>${location}</small>`;
            
            renderCategories();
            renderMaterials();
            updateSelectedUI();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é¢„é€‰çš„ç‰©æ–™ï¼ˆä»å¡ç‰‡ç‚¹å‡»è¿›æ¥ï¼‰
            const preselect = sessionStorage.getItem('preselectMaterial');
            if (preselect) {
                // æ‰¾åˆ°è¯¥ç‰©æ–™æ‰€å±åˆ†ç±»å¹¶åˆ‡æ¢
                Object.keys(materialsData).forEach(category => {
                    const item = materialsData[category].find(m => m.code === preselect);
                    if (item) {
                        switchCategory(category);
                        // è‡ªåŠ¨è®¾ç½®æ•°é‡ä¸º1
                        setQuantity(preselect, 1);
                    }
                });
                // æ¸…é™¤é¢„é€‰æ ‡è®°
                sessionStorage.removeItem('preselectMaterial');
            }
        }

        // æ¸²æŸ“åˆ†ç±»
        function renderCategories() {
            const sidebar = document.getElementById('categorySidebar');
            const categories = Object.keys(materialsData);
            
            sidebar.innerHTML = categories.map(cat => `
                <div class="category-item ${cat === currentCategory ? 'active' : ''}" 
                     onclick="switchCategory('${cat}')">
                    ${cat}
                </div>
            `).join('');
        }

        // åˆ‡æ¢åˆ†ç±»
        function switchCategory(category) {
            currentCategory = category;
            renderCategories();
            renderMaterials();
        }

        // æ¸²æŸ“ç‰©æ–™åˆ—è¡¨
        function renderMaterials() {
            const list = document.getElementById('materialList');
            let html = '';
            
            Object.keys(materialsData).forEach(category => {
                // åˆ†ç±»åˆ†éš”ç¬¦
                html += `<div class="category-divider">${category}</div>`;
                
                // è¯¥åˆ†ç±»ä¸‹çš„ç‰©æ–™
                materialsData[category].forEach(item => {
                    const qty = selectedItems[item.code] || 0;
                    html += `
                        <div class="material-item">
                            <div class="material-info">
                                <div class="material-name">${item.name}</div>
                                <div class="material-stock">åº“å­˜: ${item.remaining}${item.unit} Â· æœ€å¤§: ${item.max}${item.unit}</div>
                            </div>
                            <div class="quantity-control">
                                <button class="qty-btn minus" onclick="adjustQuantity('${item.code}', -1)">âˆ’</button>
                                <input type="number" class="qty-input" id="qty-${item.code}" 
                                       value="${qty}" min="0" 
                                       onchange="setQuantity('${item.code}', this.value)">
                                <button class="qty-btn plus" onclick="adjustQuantity('${item.code}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });
            });
            
            list.innerHTML = html;
        }

        // è°ƒèŠ‚æ•°é‡
        function adjustQuantity(code, delta) {
            const currentQty = selectedItems[code] || 0;
            const newQty = Math.max(0, currentQty + delta);
            setQuantity(code, newQty);
        }

        // è®¾ç½®æ•°é‡
        function setQuantity(code, value) {
            const qty = parseInt(value) || 0;
            
            // æ‰¾åˆ°è¯¥ç‰©æ–™çš„æœ€å¤§å®¹é‡
            let maxQty = 9999;
            Object.values(materialsData).forEach(list => {
                const item = list.find(m => m.code === code);
                if (item) maxQty = item.max;
            });
            
            const validQty = Math.min(Math.max(0, qty), maxQty);
            
            if (validQty > 0) {
                selectedItems[code] = validQty;
            } else {
                delete selectedItems[code];
            }
            
            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
            const input = document.getElementById(`qty-${code}`);
            if (input) input.value = validQty;
            
            updateSelectedUI();
        }

        // æ›´æ–°å·²é€‰UI
        function updateSelectedUI() {
            const count = Object.keys(selectedItems).length;
            document.getElementById('selectedCount').textContent = count;
            
            const completeBtn = document.getElementById('completeBtn');
            const expandHint = document.getElementById('expandHint');
            
            if (count > 0) {
                completeBtn.disabled = false;
                expandHint.style.display = 'inline-flex';
            } else {
                completeBtn.disabled = true;
                expandHint.style.display = 'none';
            }
            
            renderSelectedList();
        }

        // æ¸²æŸ“å·²é€‰åˆ—è¡¨
        function renderSelectedList() {
            const list = document.getElementById('selectedList');
            const codes = Object.keys(selectedItems);
            
            if (codes.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div>æš‚æœªé€‰æ‹©ç‰©æ–™</div></div>';
                return;
            }
            
            // æ‰¾åˆ°æ‰€æœ‰é€‰ä¸­çš„ç‰©æ–™ä¿¡æ¯
            let html = '';
            Object.keys(materialsData).forEach(category => {
                materialsData[category].forEach(item => {
                    if (selectedItems[item.code]) {
                        const qty = selectedItems[item.code];
                        html += `
                            <div class="selected-item">
                                <div class="selected-item-info">
                                    <div class="selected-item-name">${item.name}</div>
                                    <div class="selected-item-qty">+${qty} ${item.unit}</div>
                                </div>
                                <button class="selected-item-remove" onclick="setQuantity('${item.code}', 0)">âœ•</button>
                            </div>
                        `;
                    }
                });
            });
            
            list.innerHTML = html;
        }

        // åˆ‡æ¢å·²é€‰é¢æ¿
        function toggleSelectedPanel() {
            const panel = document.getElementById('selectedPanel');
            const overlay = document.getElementById('overlay');
            const isShow = panel.classList.contains('show');
            
            if (isShow) {
                panel.classList.remove('show');
                overlay.classList.remove('show');
            } else {
                panel.classList.add('show');
                overlay.classList.add('show');
            }
        }

        // å®Œæˆè¡¥æ–™ - æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        function completeRefill() {
            const count = Object.keys(selectedItems).length;
            if (count === 0) return;
            
            // å¡«å……å·²é€‰ç‰©æ–™æ‘˜è¦
            const summaryDiv = document.getElementById('selectedSummary');
            let html = '<div class="summary-title">å·²é€‰ç‰©æ–™ (' + count + ')</div>';
            
            Object.keys(selectedItems).forEach(code => {
                Object.values(materialsData).forEach(list => {
                    const item = list.find(m => m.code === code);
                    if (item) {
                        html += `
                            <div class="summary-item">
                                <span class="summary-item-name">${item.name}</span>
                                <span class="summary-item-qty">+${selectedItems[code]} ${item.unit}</span>
                            </div>
                        `;
                    }
                });
            });
            
            summaryDiv.innerHTML = html;
            
            // è®¾ç½®é»˜è®¤å‘è´§æ—¶é—´ä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('deliveryTime').value = now.toISOString().slice(0, 16);
            document.getElementById('deliveryNote').value = '';
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('confirmModal').classList.add('active');
        }

        // å…³é—­ç¡®è®¤å¼¹çª—
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        // è·å–å½“å‰é€‰ä¸­çš„è®¾å¤‡
        function getCurrentDevice() {
            // ä» sessionStorage æˆ–é»˜è®¤å€¼è·å–
            return sessionStorage.getItem('currentDevice') || 'RCK111';
        }

        // è·å–ç‚¹ä½ä¿¡æ¯
        function getDeviceLocation(deviceId) {
            const locationMap = {
                'RCK111': 'ä¸Šæµ·å¸‚ä¸­å¿ƒåº—',
                'RCK112': 'åŒ—äº¬æœé˜³é—¨åº—',
                'RCK113': 'å¹¿å·å¤©æ²³åº—'
            };
            return locationMap[deviceId] || 'æœªçŸ¥ç‚¹ä½';
        }

        // ç¡®è®¤ç”Ÿæˆå‘è´§å•
        function confirmDelivery() {
            const deliveryTime = document.getElementById('deliveryTime').value;
            const note = document.getElementById('deliveryNote').value.trim();
            
            if (!deliveryTime) {
                showToast('è¯·é€‰æ‹©å‘è´§æ—¶é—´', 'error');
                return;
            }
            
            const deviceId = getCurrentDevice();
            
            // æ„å»ºå‘è´§å•æ•°æ®
            const orderId = 'DL' + Date.now();
            const orderData = {
                id: orderId,
                createTime: new Date().toISOString(),
                deliveryTime: deliveryTime,
                note: note,
                status: 'pending', // pending æˆ– completed
                // ç”³è¯·äººä¿¡æ¯
                requestedBy: 'å½“å‰ç”¨æˆ·', // å®é™…åº”ä»ç™»å½•ç³»ç»Ÿè·å–
                requestTime: new Date().toISOString(),
                // è®¾å¤‡å’Œç‚¹ä½ä¿¡æ¯
                deviceId: deviceId,
                location: getDeviceLocation(deviceId),
                // å¤„ç†ä¿¡æ¯ï¼ˆå®Œæˆæ—¶å¡«å……ï¼‰
                completedBy: null,
                completedTime: null,
                items: []
            };
            
            // æ”¶é›†ç‰©æ–™ä¿¡æ¯
            Object.keys(selectedItems).forEach(code => {
                Object.values(materialsData).forEach(list => {
                    const item = list.find(m => m.code === code);
                    if (item) {
                        orderData.items.push({
                            code: item.code,
                            name: item.name,
                            quantity: selectedItems[code],
                            unit: item.unit
                        });
                    }
                });
            });
            
            // ä¿å­˜åˆ° localStorage
            let orders = JSON.parse(localStorage.getItem('materialOrders') || '[]');
            orders.unshift(orderData);
            localStorage.setItem('materialOrders', JSON.stringify(orders));
            
            showToast('å‘è´§å•ç”ŸæˆæˆåŠŸ', 'success');
            
            // æ¸…ç©ºé€‰æ‹©
            selectedItems = {};
            updateSelectedUI();
            renderMaterials();
            
            // å…³é—­å¼¹çª—å’Œé¢æ¿
            closeConfirmModal();
            document.getElementById('selectedPanel').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
            
            // è·³è½¬åˆ°å‘è´§å•åˆ—è¡¨é¡µ
            setTimeout(() => {
                window.location.href = 'materials-orders.html';
            }, 800);
        }

        // è¿”å›
        function goBack() {
            window.location.href = 'materials.html';
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'normal') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = type === 'success' ? 'toast success show' : 'toast show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmModal();
            }
        });

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
